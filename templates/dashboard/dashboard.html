<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lora GEN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: { 600: '#2563eb', 700: '#1d4ed8' } } } }
        };

        if (localStorage.theme === 'dark' ||
            (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const sunIcon = document.getElementById('icon-sun');
            const moonIcon = document.getElementById('icon-moon');
            const isDark = html.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
            sunIcon.classList.toggle('hidden', isDark);
            moonIcon.classList.toggle('hidden', !isDark);
        }

        async function logout() {
            try {
                const res = await fetch('/auth/logout', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                if (!res.ok) throw new Error(`Logout failed: ${res.status}`);
                window.location.href = '/auth/login';
            } catch (e) { console.error(e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const sunIcon = document.getElementById('icon-sun');
            const moonIcon = document.getElementById('icon-moon');
            sunIcon.classList.toggle('hidden', document.documentElement.classList.contains('dark'));
            moonIcon.classList.toggle('hidden', !document.documentElement.classList.contains('dark'));
        });
    </script>
</head>

<body class="flex flex-col min-h-screen bg-gray-50 dark:bg-gray-900">
    {% include 'components/_navbar.html' %}


    <main class="flex flex-grow max-w-5xl w-full overflow-x-auto mx-auto px-4 pt-[5rem] pb-4 mt-4">


        <form id="generate" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col gap-6 w-full">

            <div class="flex flex-col gap-2">
                {% if user.disabled == "True" %}
                <div
                    class="w-full p-3 rounded-lg bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-200 text-center font-medium">
                    ðŸš« Account disabled. Try again later.
                </div>
                {% endif %}
            </div>
            <div id="alert"
                class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative">
                <strong class="font-bold" id="alert-title"></strong>
                <span class="block sm:inline" id="alert-message"></span>
            </div>

            <div class="flex flex-col flex-grow">
                <textarea name="prompt" rows="5" placeholder="Type your prompt here..."
                    class="resize-none w-full flex-grow p-4 border rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200"
                    {% if user.disabled=="True" or credits<=0 %} disabled {% endif
                    %}>{{ session.get('last_prompt', '') }}</textarea>

                <div id="char-count" class="text-xs text-gray-400 dark:text-gray-500 mt-2 text-right select-none">
                </div>
            </div>

            <button type="submit"
                class="w-full py-3 bg-blue-600 text-white rounded-lg flex items-center justify-center gap-2 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                {% if user.disabled=="True" or credits<=0 %} disabled {% endif %}>
                Generate <i data-lucide="coins" class="w-5 h-5"></i>
                <span> {{ credits }}</span>
            </button>

            <div class="overflow-x-auto pb-2">
                <div class="flex gap-4 min-w-max">
                    <div class="flex-col gap-2">
                        <div class="flex items-center mb-2">
                            <input id="select-all-images" type="checkbox"
                                class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600 m-2">
                            <label for="select-all-images" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                Select/Unselect All
                            </label>
                        </div>
                        <a href="{{ url_for('dashboard.basket_get') }}"
                            class="flex-shrink-0 w-40 aspect-square flex items-center justify-center rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 text-gray-400 dark:text-gray-500 text-3xl font-bold hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                            +
                        </a>
                        <!-- Select/Unselect All -->
                    </div>

                    {% if images %}
                    {% for image in images %}
                    <label class="relative flex-shrink-0 w-40 aspect-square cursor-pointer">
                        <input type="checkbox" name="images" value="{{ image.id }}"
                            class="absolute top-2 left-2 w-6 h-6 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                            {% if image.id in session.get('last_selected_images', []) %} checked {% endif %}>
                        <img src="{{ image.url }}"
                            class="w-full h-full object-cover rounded-lg border border-gray-300 dark:border-gray-700" />
                    </label>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="repeat" class="block mb-2 text-gray-700 dark:text-gray-200">Repeat (Max
                        {{ 5 if credits >= 5 else credits }}):</label>
                    <input type="number" name="repeat" id="repeat" min="1" max="{{ max_repeat }}"
                        value="{{ session.get('last_repeat', 1) }}"
                        class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500"
                        {% if user.disabled=="True" or credits<=0 %} disabled {% endif %} required>
                </div>
                <div>
                    <label for="resolution" class="block mb-2 text-gray-700 dark:text-gray-200">Resolution:</label>
                    {% set resolutions = [
                    {"value":"1:1-1K","width":1024,"height":1024,"label":"1:1 (1K / Square)"},
                    {"value":"1:1-2K","width":2048,"height":2048,"label":"1:1 (2K / Square)"},
                    {"value":"1:1-4K","width":4096,"height":4096,"label":"1:1 (4K / Square)"},
                    {"value":"4:3-2K","width":2048,"height":1536,"label":"4:3 (2K / Landscape)"},
                    {"value":"4:3-4K","width":4096,"height":3072,"label":"4:3 (4K / Landscape)"},
                    {"value":"16:9-2K","width":2048,"height":1152,"label":"16:9 (2K / Landscape)"},
                    {"value":"16:9-4K","width":4096,"height":2304,"label":"16:9 (4K / Landscape)"},
                    {"value":"3:2-2K","width":2048,"height":1365,"label":"3:2 (2K / Landscape)"},
                    {"value":"3:2-4K","width":4096,"height":2730,"label":"3:2 (4K / Landscape)"},
                    {"value":"21:9-2K","width":2048,"height":878,"label":"21:9 (2K / Landscape)"},
                    {"value":"21:9-4K","width":4096,"height":1756,"label":"21:9 (4K / Landscape)"},
                    {"value":"3:4-2K","width":1536,"height":2048,"label":"3:4 (2K / Portrait)"},
                    {"value":"3:4-4K","width":3072,"height":4096,"label":"3:4 (4K / Portrait)"},
                    {"value":"9:16-2K","width":1152,"height":2048,"label":"9:16 (2K / Portrait)"},
                    {"value":"9:16-4K","width":2304,"height":4096,"label":"9:16 (4K / Portrait)"},
                    {"value":"2:3-2K","width":1365,"height":2048,"label":"2:3 (2K / Portrait)"},
                    {"value":"2:3-4K","width":2730,"height":4096,"label":"2:3 (4K / Portrait)"}
                    ] %}

                    <select id="resolution" name="resolution"
                        class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500">
                        {% for res in resolutions %}
                        <option value="{{ res.value }}" data-width="{{ res.width }}" data-height="{{ res.height }}" {%
                            if is_disabled %}disabled{% endif %}>
                            {{ res.label }}
                        </option>
                        {% endfor %}
                    </select>

                </div>
                <div>
                    <label for="width" class="block mb-2 text-gray-700 dark:text-gray-200">Width:</label>
                    <input type="text" id="width" readonly value="{{ session.get('last_width', 1024) }}"
                        class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-500 focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="height" class="block mb-2 text-gray-700 dark:text-gray-200">Height:</label>
                    <input type="text" id="height" readonly value="{{ session.get('last_height', 1024) }}"
                        class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-500 focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="sm:col-span-2">
                    <label for="type" class="block mb-2 text-gray-700 dark:text-gray-200">Type:</label>
                    <select id="type" name="type" class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg 
               bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 
               focus:ring-2 focus:ring-blue-500">
                        <option value="Professional" {% if session.get('last_type', 'Professional' )=='Professional' %}
                            selected {% endif %}>Professional</option>
                        <option value="NSFW" {% if session.get('last_type', 'Professional' )=='NSFW' %} selected {%
                            endif %}>NSFW</option>
                    </select>
                </div>

            </div>
        </form>
    </main>

    {% include 'components/_modal-navbar.html' %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const res = document.getElementById('resolution'),
                w = document.getElementById('width'),
                h = document.getElementById('height'),
                ta = document.querySelector("textarea[name='prompt']"),
                count = document.getElementById("char-count"),
                repeat = document.getElementById('repeat'),
                typeSelect = document.getElementById('type');
            MAX = 3000;

            const setDims = () => {
                const o = res.selectedOptions[0];
                w.value = o.dataset.width;
                h.value = o.dataset.height;
            };
            setDims();
            res.addEventListener('change', setDims);

            ta.addEventListener("input", () => {
                if (ta.value.length > MAX) ta.value = ta.value.slice(0, MAX);
                count.textContent = `${ta.value.length}/${MAX}`;

                const length = ta.value.length;
                if (length < MAX / 2) {
                    count.classList.remove('text-yellow-400', 'dark:text-yellow-500');
                    count.classList.add('text-gray-400', 'dark:text-gray-500');
                } else if (length < MAX) {
                    count.classList.remove('text-gray-400', 'dark:text-gray-500');
                    count.classList.remove('text-red-400', 'dark:text-red-500');
                    count.classList.add('text-yellow-400', 'dark:text-yellow-500');
                } else {
                    count.classList.remove('text-gray-400', 'dark:text-gray-500');
                    count.classList.add('text-red-400', 'dark:text-red-500');
                }
            });

            // Set initial character count on page load
            count.textContent = `${ta.value.length}/${MAX}`;
            count.classList.toggle('text-red-500', ta.value.length >= MAX);


            repeat.addEventListener('input', () => {
                let v = Math.min(Math.max(parseInt(repeat.value) || 1, 1), Number(repeat.max));
                repeat.value = v;
            });

            // JS fetch submission
            document.getElementById('generate').addEventListener('submit', async e => {
                e.preventDefault();

                const prompt = ta.value.trim();
                if (!prompt) { showAlert("Warning", "Fill your prompt first", "info"); return; }

                const checkedImages = [...document.querySelectorAll('input[name="images"]:checked')];
                if (checkedImages.length === 0) { showAlert("Warning", "Select at least one reference image", "info"); return; }

                const payload = {
                    prompt,
                    repeat: repeat.value,
                    resolution: res.value,
                    width: w.value,
                    height: h.value,
                    images: checkedImages.map(c => c.value),
                    type: typeSelect.value
                };

                try {
                    const response = await fetch("/dashboard/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    if (response.ok) {
                        showAlert("Success", "Jobs submitted", "success");
                    } else {
                        showAlert("Error", data.message, "error");
                    }

                } catch (error) {
                    console.error("Login error:", error);
                    showAlert("Error", error, "error");
                }
            });

            const selectAllImages = document.getElementById('select-all-images');
            const imageCheckboxes = document.querySelectorAll('input[name="images"]');

            selectAllImages.addEventListener('change', () => {
                imageCheckboxes.forEach(cb => cb.checked = selectAllImages.checked);
            });

            imageCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const allChecked = [...imageCheckboxes].every(c => c.checked);
                    selectAllImages.checked = allChecked;
                });
            });

        });

        function showAlert(title, message, type = "error") {
            const alertDiv = document.querySelector("#alert");
            const alertTitle = alertDiv.querySelector("#alert-title");
            const alertMessage = alertDiv.querySelector("#alert-message");

            // Set title and message
            alertTitle.textContent = title;
            alertMessage.textContent = message;

            // Remove existing color classes
            alertDiv.classList.remove(
                "text-blue-800", "border-blue-300", "bg-blue-50",
                "text-green-800", "border-green-300", "bg-green-50",
                "text-red-800", "border-red-300", "bg-red-50",
                "dark:text-blue-400", "dark:border-blue-800", "dark:bg-gray-800",
                "dark:text-green-400", "dark:border-green-800", "dark:bg-gray-800",
                "dark:text-red-400", "dark:border-red-800", "dark:bg-gray-800"
            );

            // Add classes based on type
            if (type === "success") {
                alertDiv.classList.add(
                    "text-green-800", "border-green-300", "bg-green-50",
                    "dark:text-green-400", "dark:border-green-800", "dark:bg-gray-800"
                );
            } else if (type === "error") {
                alertDiv.classList.add(
                    "text-red-800", "border-red-300", "bg-red-50",
                    "dark:text-red-400", "dark:border-red-800", "dark:bg-gray-800"
                );
            } else if (type === "info") {
                alertDiv.classList.add(
                    "text-blue-800", "border-blue-300", "bg-blue-50",
                    "dark:text-blue-400", "dark:border-blue-800", "dark:bg-gray-800"
                );
            }

            // Show the alert
            alertDiv.classList.remove("hidden");
        }

        function resetForm() {
            const form = document.getElementById('generate');
            const count = document.getElementById('char-count');
            const res = document.getElementById('resolution');
            const w = document.getElementById('width');
            const h = document.getElementById('height');

            form.reset();
            count.textContent = "0/3000";
            const o = res.selectedOptions[0];
            w.value = o.dataset.width;
            h.value = o.dataset.height;

            document.querySelectorAll('input[name="images"]').forEach(input => input.checked = false);
        }


    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const menu = document.getElementById('mobile-menu');
            const openBtn = document.getElementById('hamburger-btn');
            const closeBtn = document.getElementById('close-menu');

            if (openBtn && menu && closeBtn) {
                openBtn.addEventListener('click', () => {
                    menu.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // prevent background scroll
                });

                closeBtn.addEventListener('click', () => {
                    menu.classList.add('hidden');
                    document.body.style.overflow = ''; // restore scroll
                });
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const typeSelect = document.getElementById('type');
            const resolutionSelect = document.getElementById('resolution');

            function updateResolutionOptions() {
                const isProfessional = typeSelect.value === "Professional";

                [...resolutionSelect.options].forEach(option => {
                    if (isProfessional && (option.text.includes('2K') || option.text.includes('4K'))) {
                        option.disabled = true;
                        // If currently selected, reset to first enabled option
                        if (option.selected) {
                            const firstEnabled = [...resolutionSelect.options].find(opt => !opt.disabled);
                            if (firstEnabled) firstEnabled.selected = true;
                        }
                    } else {
                        option.disabled = false;
                    }
                });
            }

            // Initialize on page load
            updateResolutionOptions();

            // Update when type changes
            typeSelect.addEventListener('change', updateResolutionOptions);
        });
    </script>



</body>

</html>