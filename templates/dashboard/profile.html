<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lora GEN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 600: '#2563eb', 700: '#1d4ed8' }
                    }
                }
            }
        }

        // Dark mode setup
        if (localStorage.theme === 'dark' || (!('theme' in localStorage)
            && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const sunIcon = document.getElementById('icon-sun');
            const moonIcon = document.getElementById('icon-moon');
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        }

        async function logout() {
            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Logout failed: ${response.status}`);
                }

                // Optionally handle response
                const result = await response.json();
                console.log('Logged out:', result.message);

                window.location.href = '/auth/login';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }


        window.addEventListener('DOMContentLoaded', () => {
            const sunIcon = document.getElementById('icon-sun');
            const moonIcon = document.getElementById('icon-moon');
            if (document.documentElement.classList.contains('dark')) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            lucide.createIcons();
        });
    </script>
</head>

<body class="bg-gray-50 dark:bg-gray-900">

    {% include 'components/_navbar.html' %}

    <!-- Main Content -->
    <main class="flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900 pt-24 px-4">
        <div
            class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 sm:p-10 flex flex-col gap-8 transition duration-200">
            <h2 class="text-3xl font-semibold text-gray-800 dark:text-gray-100 text-center">Profile Settings</h2>

            <form id="form-profile" class="flex flex-col gap-6">
                <div id="alert"
                    class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative">
                    <strong class="font-bold" id="alert-title"></strong>
                    <span class="block sm:inline" id="alert-message"></span>
                </div>
                <!-- Full Name -->
                <div class="flex flex-col gap-2">
                    <label for="full_name" class="text-gray-700 dark:text-gray-200 font-medium">Full Name</label>
                    <input id="full_name" type="text" name="full_name" placeholder="John Doe"
                        value="{{ user.full_name }}"
                        class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <!-- Password -->
                <div class="flex flex-col gap-2">
                    <label for="password" class="text-gray-700 dark:text-gray-200 font-medium">New Password</label>
                    <input id="password" type="password" name="password" placeholder="••••••••"
                        class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <!-- Email (Disabled) -->
                <div class="flex flex-col gap-2">
                    <label for="email" class="text-gray-700 dark:text-gray-200 font-medium">Email</label>
                    <input id="email" type="email" disabled value="{{ user.email }}"
                        class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 cursor-not-allowed opacity-80">
                </div>

                <!-- Submit Button -->
                <div class="flex justify-center">
                    <button type="submit"
                        class="w-full sm:w-auto px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg flex items-center justify-center gap-2 shadow-md transition">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        <span>Update Profile</span>
                    </button>
                </div>
            </form>
        </div>
    </main>

    {% include 'components/_modal-navbar.html' %}

    <script>
        document.getElementById('form-profile').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fullNameInput = document.getElementById('full_name');
            const passwordInput = document.getElementById('password');

            const full_name = fullNameInput.value.trim();
            const password = passwordInput.value.trim();

            // Compare with existing data (from Jinja)
            const currentFullName = "{{ user.full_name }}";

            // Check if something changed
            const nameChanged = full_name !== currentFullName;
            const passwordValid = password.length >= 8;

            if (!nameChanged && !password) {
                showAlert("Info", "No changes to update.", "info");
                return;
            }

            if (password && !passwordValid) {
                showAlert("Info", "Password must be at least 8 characters long.", "info");
                return;
            }

            const data = { full_name };
            if (passwordValid) {
                data.password = password;
            }

            try {
                const response = await fetch('/dashboard/profile/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert("Success", "Profile updated successfully.", "success");
                    
                    passwordInput.value = "";
                } else {
                    showAlert("Error", "Failed to update profile.", "error");
                }
            } catch (error) {
                showAlert("Error", "Failed to update profile.", "error");
            }
        });

        function showAlert(title, message, type = "error") {
            const alertDiv = document.querySelector("#alert");
            const alertTitle = alertDiv.querySelector("#alert-title");
            const alertMessage = alertDiv.querySelector("#alert-message");

            // Set title and message
            alertTitle.textContent = title;
            alertMessage.textContent = message;

            // Remove existing color classes
            alertDiv.classList.remove(
                "text-blue-800", "border-blue-300", "bg-blue-50",
                "text-green-800", "border-green-300", "bg-green-50",
                "text-red-800", "border-red-300", "bg-red-50",
                "dark:text-blue-400", "dark:border-blue-800", "dark:bg-gray-800",
                "dark:text-green-400", "dark:border-green-800", "dark:bg-gray-800",
                "dark:text-red-400", "dark:border-red-800", "dark:bg-gray-800"
            );

            // Add classes based on type
            if (type === "success") {
                alertDiv.classList.add(
                    "text-green-800", "border-green-300", "bg-green-50",
                    "dark:text-green-400", "dark:border-green-800", "dark:bg-gray-800"
                );
            } else if (type === "error") {
                alertDiv.classList.add(
                    "text-red-800", "border-red-300", "bg-red-50",
                    "dark:text-red-400", "dark:border-red-800", "dark:bg-gray-800"
                );
            } else if (type === "info") {
                alertDiv.classList.add(
                    "text-blue-800", "border-blue-300", "bg-blue-50",
                    "dark:text-blue-400", "dark:border-blue-800", "dark:bg-gray-800"
                );
            }

            // Show the alert
            alertDiv.classList.remove("hidden");
        }

    </script>

     <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const menu = document.getElementById('mobile-menu');
            const openBtn = document.getElementById('hamburger-btn');
            const closeBtn = document.getElementById('close-menu');

            if (openBtn && menu && closeBtn) {
                openBtn.addEventListener('click', () => {
                    menu.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // prevent background scroll
                });

                closeBtn.addEventListener('click', () => {
                    menu.classList.add('hidden');
                    document.body.style.overflow = ''; // restore scroll
                });
            }
        });
    </script>


</body>

</html>